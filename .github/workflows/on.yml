name: Build onnxruntime for Debian 13 ARM64 (Python 3.10.19)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run build in Debian 13 ARM64 container
        run: |
          # Create a local directory to store the built wheels
          mkdir -p ${{ github.workspace }}/dist

          docker run --rm --privileged \
            --platform linux/arm64 \
            -v ${{ github.workspace }}/dist:/build/dist \
            -w /workspace \
            arm64v8/debian:trixie \
            bash -c "
              set -e

              # Install system dependencies for building Python and onnxruntime
              apt-get update
              apt-get install -y \
                wget build-essential libssl-dev zlib1g-dev libbz2-dev \
                libreadline-dev libsqlite3-dev libncursesw5-dev xz-utils tk-dev \
                libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev \
                cmake git protobuf-compiler libprotobuf-dev ccache

              # Compile and install Python 3.10.19
              cd /tmp
              wget https://www.python.org/ftp/python/3.10.19/Python-3.10.19.tgz
              tar -xzf Python-3.10.19.tgz
              cd Python-3.10.19
              ./configure --enable-optimizations --prefix=/usr/local/python3.10
              make -j\$(nproc)
              make install

              # Add Python 3.10 to PATH and verify
              export PATH=/usr/local/python3.10/bin:\$PATH
              python3.10 --version

              # Clone onnxruntime repository
              git clone --recursive https://github.com/microsoft/onnxruntime.git /onnxruntime_src
              cd /onnxruntime_src

              # Use the official build script, overriding Python interpreter and adding cpuinfo disable flag
              ./tools/ci_build/github/linux/build_linux_python_package.sh \
                -d CPU \
                -p /usr/local/python3.10/bin/python3.10 \
                -c Release \
                -x \"--cmake_extra_defines onnxruntime_ENABLE_CPUINFO=OFF\"
            "

      - name: Upload built wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-debian13-arm64-py310-wheel
          path: ${{ github.workspace }}/dist/*.whl
