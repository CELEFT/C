name: Build onnxruntime for Python 3.10.19 on Debian 13 ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build onnxruntime in Debian 13 container
        run: |
          docker run --rm --privileged \
            --platform linux/arm64 \
            -v /sys:/sys \
            arm64v8/debian:trixie \
            bash -c "
              set -e  # Exit on any error

              # Install system dependencies
              apt-get update
              apt-get install -y \
                wget build-essential libssl-dev zlib1g-dev libbz2-dev \
                libreadline-dev libsqlite3-dev libncursesw5-dev xz-utils tk-dev \
                libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev \
                cmake git protobuf-compiler libprotobuf-dev ccache

              # Download and compile Python 3.10.19
              cd /tmp
              wget https://www.python.org/ftp/python/3.10.19/Python-3.10.19.tgz
              tar -xzf Python-3.10.19.tgz
              cd Python-3.10.19
              ./configure --enable-optimizations --prefix=/usr/local/python3.10
              make -j\$(nproc)  # Use all cores, but can reduce if memory limited
              make install

              # Add Python 3.10 to PATH
              export PATH=/usr/local/python3.10/bin:\$PATH
              python3.10 --version

              # Create virtual environment
              python3.10 -m venv /venv310
              source /venv310/bin/activate
              pip install --upgrade pip numpy packaging wheel

              # Clone onnxruntime with submodules
              git clone --recursive https://github.com/microsoft/onnxruntime.git
              cd onnxruntime

              # Build onnxruntime with custom CMake options
              python3 tools/ci_build/build.py \
                --build_dir build/Linux \
                --config Release \
                --build_shared_lib \
                --parallel \
                --enable_pybind \
                --cmake_extra_defines onnxruntime_ENABLE_CPUINFO=OFF \
                --cmake_extra_defines Python_EXECUTABLE=/venv310/bin/python

              # Install the generated wheel
              cd build/Linux/Release/dist
              pip install onnxruntime-*.whl
              python -c \"import onnxruntime; print('ONNX Runtime version:', onnxruntime.__version__)\"
            "

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-debian13-arm64-py310-wheel
          path: onnxruntime/build/Linux/Release/dist/onnxruntime-*.whl
